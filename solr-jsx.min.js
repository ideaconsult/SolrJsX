!function(){Solr={version:"0.10.4"},function(e,t){e.Management=function(e){t.extend(!0,this,e),this.listeners={},this.response=null,this.error=null,this.currentRequest=null,this.pendingRequest=null},e.Management.prototype={__expects:["prepareQuery","parseQuery"],connector:null,solrUrl:"",servlet:"select",onError:function(e){window.console&&console.log&&console.log(e)},onPrepare:function(e){},onSuccess:null,ajaxSettings:{async:!0,dataType:"json",method:"GET",processData:!1},doRequest:function(e){var r=this,a=null,n={};return null!=r.currentRequest&&r.currentRequest==e?void(r.pendingRequest=e||r.servlet):(r.inRequest=!0,t.each(r.listeners,function(e){t.act(e,e.beforeRequest,r)===!1&&(a=e)}),null!==a?void t.act(a,r.onError,"Request cancelled",a):(n=t.extend(n,r.ajaxSettings,r.prepareQuery()),n.url=r.solrUrl+(e||r.servlet)+(n.url||""),n.error=r.onError,n.success=function(a){r.response=r.parseQuery(a),t.each(r.listeners,function(a){t.act(a,a.afterRequest,r.response,e)}),t.act(r,r.parseResponse,r.response,e),t.act(r,r.onSuccess),r.currentRequest=null,r.pendingRequest&&r.doRequest(r.pendingRequest)},t.broadcast(r,"onPrepare",n),t.act(r,r.onPrepare,n),r.connector.ajax(n)))},init:function(){var r=this;t.pass(r,e.Management,"init"),t.each(this.listeners,function(e){t.act(e,e.init,r)})},addListeners:function(e){var t=e;t=arguments.length>1?arguments:Array.isArray(e)?e:[e];for(var r,a=0,n=t.length;a<n;++a)r=t[a],this.listeners[r.id]=r;return this},removeListener:function(e){return"objcet"==typeof e&&(e=e.id),delete this.listeners[e],this},removeManyListeners:function(e){if("function"!=typeof e)throw{name:"Enumeration error",message:"Attempt to select-remove listeners with non-function 'selector': "+e};var r=this;return t.each(r.listeners,function(t,a){e(t,a,r)&&delete r.listeners[a]}),r},enumerateListeners:function(e,r){if("function"!=typeof e)throw{name:"Enumeration error",message:"Attempt to enumerate listeners with non-function 'selector': "+e};t.each(this.listeners,function(t,a){e.call(t,t,a,r)})},getListener:function(e){return this.listeners[e]}}}(Solr,asSys),function(e,t){e.escapeValue=function(e){return"string"!=typeof e&&(e=e.toString()),!e.match(/[ :\/"]/)||e.match(/[\[\{]\S+ TO \S+[\]\}]/)||e.match(/^["\(].*["\)]$/)?e:'"'+e.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'},e.parseParameter=function(e){var t={},r=e.match(/^([^=]+)=(?:\{!([^\}]*)\})?(.*)$/);if(r){if(null!=r[2])for(var a;a=/([^\s=]+)=?(\S*)?/g.exec(r[2]);)void 0===t.domain&&(t.domain={}),null==a[2]?t.domain.type=a[1]:t.domain[a[1]]=a[2],r[2]=r[2].replace(a[0],"");t.name=r[1];var n=r[3].split(",");t.value=n.length>1?n:r[3]}return t},e.Configuring=function(r){var a=this,n=null;null!=r&&(n=r.parameters,delete r.parameters),t.extend(!0,this,r),this.resetParameters(),t.each(n,function(t,r){"string"==typeof t?a.addParameter(e.parseParameter(r+"="+t)):a.addParameter(r,t)})};var r=function(e){return e.match(/^(?:bf|bq|facet\.date|facet\.date\.other|facet\.date\.include|facet\.field|facet\.pivot|facet\.range|facet\.range\.other|facet\.range\.include|facet\.query|fq|json\.query|json\.filter|group\.field|group\.func|group\.query|pf|qf|stats\.field)$/)};e.Configuring.prototype={addParameter:function(e,a,n){var i;if("object"!=typeof e?(i=e,e={name:e,value:a},void 0!==n&&(e.domain=n)):i=e.name,r(i))if(void 0===this.parameterStore[i])this.parameterStore[i]=[e];else{var s=!1;if(t.each(this.parameterStore[i],function(r){s=s||t.equal(!0,e,r)}),s)return!1;this.parameterStore[i].push(e)}else this.parameterStore[i]=e;return e},findParameters:function(e,a){var n,i=[];return void 0!==this.parameterStore[e]&&("function"==typeof a?n=function(e,t){a(e,t)&&i.push(t)}:null==a?n=function(e,t){i.push(t)}:(("object"!=typeof a||a instanceof RegExp||Array.isArray(a))&&(a={value:a}),n=function(e,r){t.similar(e,a)&&i.push(r)}),t.each(r(e)?this.parameterStore[e]:[this.parameterStore[e]],n)),i},removeParameters:function(e,t){if(void 0!==this.parameterStore[e]){if("number"==typeof t?t=[t]:Array.isArray(t)||(t=this.findParameters(e,t)),r(e)&&t.length!=this.parameterStore[e].length){t.sort(function(e,t){return e<t?-1:e>t?1:0});for(var a=t.length-1;a>=0;--a)this.parameterStore[e].splice(t[a],1)}else delete this.parameterStore[e];return t.length}return!1},getParameter:function(e,t){if(void 0===this.parameterStore[e]){var a={name:e};this.parameterStore[e]=r(e)?[a]:a}return null!=t&&r(e)?this.parameterStore[e][t]:this.parameterStore[e]},getAllValues:function(e){var t=null;return void 0!==this.parameterStore[e]&&(t=r(e)?this.parameterStore[e].map(function(e){return e.value}):this.parameterStore[e].value),t},enumerateParameters:function(e,r){"boolean"!=typeof e&&(r=e,e=!0),t.each(this.parameterStore,function(a){e&&Array.isArray(a)?t.each(a,r):r(a)})},resetParameters:function(){this.parameterStore={}}}}(Solr,asSys),function(e,t){e.Compatibility=function(e){t.extend(!0,this,e),this.store.root=this},e.Compatibility.prototype={store:{addByValue:function(e,t,r){return this.root.addParameter(e,t,r)},removeByValue:function(e,t){return this.root.removeParameters(e,indices)},find:function(e,t){return this.root.findParameters(e,neddle)}}}}(Solr,asSys),function(e,t){e.stringifyDomain=function(e){var r=[];return t.each(e.domain,function(e,t){r.push(("type"!==t?t+"=":"")+e)}),r.length>0?"{!"+r.join(" ")+"}":""},e.QueryingURL=function(e){t.extend(!0,this,e)};var r=function(r){if(Array.isArray(r))return r.join(",");if("object"!=typeof r)return r.toString();var a=[];return t.each(r,function(t,r){a.push(r+":"+e.escapeValue(t))}),a.join(" ")};e.QueryingURL.prototype={__expects:["enumerateParameters"],prepareParameter:function(t){var a=e.stringifyDomain(t);return t.value||a?t.name+"="+encodeURIComponent(a+r(t.value||"q"==t.name&&"*:*")):null},prepareQuery:function(){var e=[],t=this;return this.enumerateParameters(function(r){var a=t.prepareParameter(r);null!=a&&e.push(a)}),{url:"?"+e.join("&")}},parseQuery:function(e){return e}}}(Solr,asSys),function(e,t){var r=function(e){return e.match(/^(json\.nl|json\.wrf|q|wt)/)},a=function(e){var t=e.match(/^json\.?(.*)/);return t&&t[1]};e.QueryingJson=function(e){this.useBody=!0,t.extend(!0,this,e)},e.QueryingJson.prototype={__expects:["enumerateParameters"],prepareQuery:function(){var n=[],i={params:{}},s=function(a){if(r(a.name))return void n.push(e.QueryingURL.prototype.prepareParameter(a));var i=null;return i="string"==typeof a.value?e.stringifyDomain(a)+a.value:void 0!==a.domain?t.extend({},a.value,{domain:a.domain}):a.value};return this.enumerateParameters(!1,function(e){var r=Array.isArray(e)?e.map(s):s(e),n=Array.isArray(e)?e[0].name:e.name,o=a(n);void 0!=r&&(null!==o?t.path(i,o,r):i.params[n]=r)}),i=JSON.stringify(i),this.useBody?{url:"?"+n.join("&"),data:i,contentType:"application/json",type:"POST",method:"POST"}:(n.push(encodeURIComponent(i)),{url:"?"+n.join("&")})},parseQuery:function(e){if(null!=e.responseHeader.params.json){var r=JSON.parse(e.responseHeader.params.json);t.extend(e.responseHeader.params,r,r.params),delete e.responseHeader.params.json}return e}}}(Solr,asSys),function(e,t){e.Persistency=function(e){t.extend(!0,this,e),this.storage={}},e.Persistency.prototype={__depends:[e.Configuring],persistentParams:[],addParameter:function(e,r,a){return t.pass(this,"addParameter",Solf.Configuring,e,r,a),e},removeParameters:function(e){t.pass(this,"removeParameters",Solf.Configuring,e)},onPrepare:function(e){}}}(Solr,asSys),function(e,t){e.Paging=function(e){t.extend(!0,this,e),this.manager=null,this.currentPage=this.totalPages=this.totalEntries=null},e.Paging.prototype={pageSize:20,multivalue:!1,exclusion:!1,domain:null,init:function(e){this.manager=e,this.manager.addParameter("rows",this.pageSize)},setPage:function(e){return null!=this.totalPages&&("next"===e||">"===e?e=this.currentPage+1:"prev"===e||"previous"===e||"<"===e?e=this.currentPage-1:"first"===e||"start"===e?e=1:"last"===e||"end"===e?e=this.totalPages:"number"!=typeof e&&(e=parseInt(e)),!(e>this.totalPages||e<1||e===this.currentPage)&&(this.currentPage=e,this.manager.addParameter("start",(e-1)*this.pageSize,this.domain)))},page:function(e){return void 0!==e&&this.setPage(e),this.currentPage},previousPage:function(){return this.currentPage>1?this.currentPage-1:null},nextPage:function(){return this.currentPage<this.totalPages?this.currentPage+1:null},afterRequest:function(){var e=parseInt(this.manager.response.responseHeader&&this.manager.response.responseHeader.params&&this.manager.response.responseHeader.params.start||this.manager.getParameter("start").value||0);this.pageSize=parseInt(this.manager.response.responseHeader&&this.manager.response.responseHeader.params&&this.manager.response.responseHeader.params.rows||this.manager.getParameter("rows").value||this.pageSize),this.totalEntries=parseInt(this.manager.response.response.numFound),this.currentPage=Math.floor(e/this.pageSize)+1,this.totalPages=Math.ceil(this.totalEntries/this.pageSize)},clickHandler:function(e){var t=this;return function(){return t.setPage(e)&&t.manager.doRequest(),!1}}}}(Solr,asSys),function(e,t){e.Texting=function(e){t.extend(!0,this,e),this.manager=null,this.delayTimer=null},e.Texting.prototype={delayed:!1,domain:null,init:function(e){this.manager=e},doRequest:function(){if(null==this.delayed)return this.manager.doRequest();null!=this.delayTimer&&clearTimeout(this.delayTimer);var e=this;this.delayTimer=setTimeout(function(){e.manager.addParameter("start",0),e.manager.doRequest(),e.delayTimer=null},this.delayed)},set:function(e){var r=this.manager.getParameter("q"),a=this.manager.addParameter("q",e,this.domain);return after=this.manager.getParameter("q"),a&&!t.equal(r,after)},clear:function(){return this.manager.removeParameters("q")},unclickHandler:function(){var e=this;return function(){return e.clear()&&e.doRequest(),!1}},clickHandler:function(e){var t=this;return function(){return t.set(e)&&t.doRequest(),!1}}}}(Solr,asSys),function(e,t){var r={prefix:null,sort:null,limit:null,offset:null,mincount:null,missing:null,method:null,"enum.cache.minDf":null},a=/\s*\(\s*?/,n=/\s*\)\s*$/;e.facetValue=function(t){return Array.isArray(t)?1==t.length?e.escapeValue(t[0]):"("+t.map(function(t){return e.escapeValue(t)}).join(" ")+")":e.escapeValue(t)},e.parseFacet=function(e){var t=e.match(/^(-)?([^\s:]+):(.+)$/);if(!t)return null;for(var r={field:t[2],exclude:!!t[1]},i=t[3].replace(a,"").replace(n,"").replace(/\\"/g,"%0022").match(/[^\s"]+|"[^"]+"/g),s=0,o=i.length;s<o;++s)i[s]=i[s].replace(/^"/,"").replace(/"$/,"").replace("%0022",'"');return r.value=o>1?i:i[0],r},e.Faceting=function(e){t.extend(!0,this,e),this.manager=null,this.multivalue||(this.aggregate=!1),this.fieldRegExp=new RegExp("^-?"+this.field+":")},e.Faceting.prototype={multivalue:!1,aggregate:!1,exclusion:!1,domain:null,useJson:!1,facet:{},init:function(a){t.pass(this,e.Faceting,"init",a),this.manager=a;var n=null;if(this.exclusion&&(this.domain=t.extend(this.domain,{tag:this.id+"_tag"}),n=this.id+"_tag"),this.useJson){var i={type:"terms",field:this.field,mincount:1,limit:-1};this.fqName="json.filter",null!=n&&(i.domain={excludeTags:n}),this.manager.addParameter("json.facet."+this.id,t.extend(i,this.facet))}else{var s=this,o=t.extend({},r),u={key:this.id};null!=n&&(u.ex=n),this.fqName="fq",this.manager.addParameter("facet",!0),void 0!==this.facet.date?(this.manager.addParameter("facet.date",this.field,u),t.extend(o,{"date.start":null,"date.end":null,"date.gap":null,"date.hardend":null,"date.other":null,"date.include":null})):void 0!==this.facet.range?(this.manager.addParameter("facet.range",this.field,u),t.extend(o,{"range.start":null,"range.end":null,"range.gap":null,"range.hardend":null,"range.other":null,"range.include":null})):(this.facet.field=!0,this.manager.addParameter("facet.field",this.field,u)),o=t.common(this.facet,o),t.each(o,function(e,t){s.manager.addParameter("f."+s.field+".facet."+t,e)})}},addValue:function(t,r){this.multivalue||this.clearValues();var a;if(!this.aggregate||!(a=this.manager.findParameters(this.fqName,this.fieldRegExp)).length)return this.manager.addParameter(this.fqName,this.fq(t,r),this.domain);var n=this.manager.getParameter(this.fqName,a[0]),i=e.parseFacet(n.value),s=!1;Array.isArray(t)||(t=[t]);for(var o,u=0,l=t.length;u<l;++u)o=t[u],i.value!=o&&(Array.isArray(i.value)&&i.value.indexOf(o)>=0||("string"==typeof i.value&&(i.value=[i.value]),i.value.push(o),s=!0));return!!s&&(n.value=this.fq(i.value,r),!0)},removeValue:function(t){if(this.multivalue){var r=this,a=!1;return this.manager.removeParameters(this.fqName,function(n){var i,s;return!!n.value.match(r.fieldRegExp)&&(r.aggregate?(i=e.parseFacet(n.value),Array.isArray(t)||(t=[t]),Array.isArray(i.value)?(i.value=i.value.filter(function(e){return t.indexOf(e)==-1||(a=!0,!1)}),!i.value.length||(1==i.value.length&&(i.value=i.value[0]),n.value=r.fq(i.value),!1)):(a=a||(s=t.indexOf(i.value)>=0),s)):(a=a||(s=n.value.indexOf(e.facetValue(t))>=0),s))}),a}return this.clearValues()},hasValue:function(t){for(var r,a=this.manager.findParameters(this.fqName,this.fieldRegExp),t=e.escapeValue(t),n=0,i=a.length;n<i;++n)if(r=this.manager.getParameter(this.fqName,a[n]),r.value.replace(this.fieldRegExp,"").indexOf(t)>-1)return!0;return!1},clearValues:function(){return this.manager.removeParameters(this.fqName,this.fieldRegExp)},getFacetCounts:function(e){var t;if(null==e&&(e=this.manager.response.facet_counts),this.useJson===!0)return e[this.id].buckets;if(void 0!==this.facet.field?t="facet_fields":void 0!==this.facet.date?t="facet_dates":void 0!==this.facet.range&&(t="facet_ranges"),void 0!==t)switch(this.manager.getParameter("json.nl").value){case"map":return this.getFacetCountsMap(e,t);case"arrarr":return this.getFacetCountsArrarr(e);default:return this.getFacetCountsFlat(e)}throw'Cannot get facet counts unless one of the following properties is set to "true" on widget "'+this.id+'": "facet.field", "facet.date", or "facet.range".'},getFacetCountsMap:function(e,t){var r=[];for(var a in e[t][this.id])r.push({val:a,count:parseInt(e[t][this.id][a])});return r},getFacetCountsArrarr:function(e,t){for(var r=[],a=0,n=e[t][this.id].length;a<n;a++)r.push({val:e[t][this.id][a][0],count:parseInt(e[t][this.id][a][1])});return r},getFacetCountsFlat:function(e,t){for(var r=[],a=0,n=e[t][this.id].length;a<n;a+=2)r.push({val:e[t][this.id][a],count:parseInt(e[t][this.id][a+1])});return r},doRequest:function(){this.manager.addParameter("start",0),this.manager.doRequest()},clickHandler:function(e){var t=this;return function(r){return t.addValue(e)&&t.doRequest(),!1}},unclickHandler:function(e){var t=this;return function(r){return t.removeValue(e)&&t.doRequest(),!1}},fq:function(t,r){return(r?"-":"")+this.field+":"+e.facetValue(t)}}}(Solr,asSys),"object"==typeof module&&module&&"object"==typeof module.exports?module.exports=Solr:(this.Solr=Solr,"function"==typeof define&&define.amd&&define(Solr))}();
