!function(e){Solr={version:"0.11.3"},Solr.Management=function(t){if(e.extend(!0,this,t),this.listeners={},this.response=null,this.error=null,this.currentRequest=null,this.pendingRequest=null,t&&t.solrUsername&&t.solrPassword){var r=btoa(t.solrUsername+":"+t.solrPassword);this.ajaxSettings.headers={Authorization:"Basic "+r}}},Solr.Management.prototype={__expects:["prepareQuery","parseQuery"],connector:null,solrUrl:"",servlet:"select",onError:function(e){window.console&&console.log&&console.log(e)},onPrepare:function(e){},onSuccess:null,ajaxSettings:{async:!0,dataType:"json",method:"GET",processData:!1},doRequest:function(t,r){var a=this,n=null,i={};return"function"==typeof t&&(r=t,t=a.servlet),null!=a.currentRequest&&a.currentRequest==t?void(a.pendingRequest=t||a.servlet):(a.inRequest=!0,e.each(a.listeners,function(t){e.act(t,t.beforeRequest,a)===!1&&(n=t)}),null!==n?void e.act(n,a.onError,"Request cancelled",n):(i=e.extend(i,a.ajaxSettings,a.prepareQuery()),i.url=a.solrUrl+(t||a.servlet)+(i.url||""),i.error=a.onError,i.success=function(n){a.response=a.parseQuery(n),"function"==typeof r?r(a.response):(e.each(a.listeners,function(r){e.act(r,r.afterRequest,a.response,t)}),e.act(a,a.parseResponse,a.response,t)),e.act(a,a.onSuccess),a.currentRequest=null,a.pendingRequest&&a.doRequest(a.pendingRequest)},e.broadcast(a,"onPrepare",i),e.act(a,a.onPrepare,i),a.connector.ajax(i)))},init:function(){var t=this;e.pass(t,Solr.Management,"init"),e.each(this.listeners,function(r){e.act(r,r.init,t)})},addListeners:function(e){var t=e;t=arguments.length>1?arguments:Array.isArray(e)?e:[e];for(var r,a=0,n=t.length;a<n;++a)r=t[a],this.listeners[r.id]=r;return this},removeListener:function(e){return"objcet"==typeof e&&(e=e.id),delete this.listeners[e],this},removeManyListeners:function(t){if("function"!=typeof t)throw{name:"Enumeration error",message:"Attempt to select-remove listeners with non-function 'selector': "+t};var r=this;return e.each(r.listeners,function(e,a){t(e,a,r)&&delete r.listeners[a]}),r},enumerateListeners:function(t,r){if("function"!=typeof t)throw{name:"Enumeration error",message:"Attempt to enumerate listeners with non-function 'selector': "+t};e.each(this.listeners,function(e,a){t.call(e,e,a,r)})},getListener:function(e){return this.listeners[e]}},Solr.escapeValue=function(e){return"string"!=typeof e&&(e=e.toString()),!e.match(/[ :\/"]/)||e.match(/[\[\{]\S+ TO \S+[\]\}]/)||e.match(/^["\(].*["\)]$/)?e:'"'+e.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'},Solr.parseParameter=function(e){var t={},r=e.match(/^([^=]+)=(?:\{!([^\}]*)\})?(.*)$/);if(r){if(null!=r[2])for(var a;a=/([^\s=]+)=?(\S*)?/g.exec(r[2]);)void 0===t.domain&&(t.domain={}),null==a[2]?t.domain.type=a[1]:t.domain[a[1]]=a[2],r[2]=r[2].replace(a[0],"");t.name=r[1];var n=r[3].split(",");t.value=n.length>1?n:r[3]}return t},Solr.Configuring=function(t){var r=this,a=null;null!=t&&(a=t.parameters,delete t.parameters),e.extend(!0,this,t),this.resetParameters(),e.each(a,function(e,t){"string"==typeof e?r.addParameter(Solr.parseParameter(t+"="+e)):r.addParameter(t,e)})};var t=function(e){return e.match(/^(?:bf|bq|facet\.date|facet\.date\.other|facet\.date\.include|facet\.field|facet\.pivot|facet\.range|facet\.range\.other|facet\.range\.include|facet\.query|fq|fl|json\.query|json\.filter|group\.field|group\.func|group\.query|pf|qf|stats\.field)$/)};Solr.Configuring.prototype={addParameter:function(r,a,n){var i;if("object"!=typeof r?(i=r,r={name:r,value:a},null!=n&&(r.domain=n)):i=r.name,t(i))if(void 0===this.parameterStore[i])this.parameterStore[i]=[r];else{var s=!1;if(e.each(this.parameterStore[i],function(t){s=s||e.equal(!0,r,t)}),s)return!1;this.parameterStore[i].push(r)}else this.parameterStore[i]=r;return r},findParameters:function(r,a){var n,i=[];return void 0!==this.parameterStore[r]&&("function"==typeof a?n=function(e,t){a(e,t)&&i.push(t)}:null==a?n=function(e,t){i.push(t)}:(("object"!=typeof a||a instanceof RegExp||Array.isArray(a))&&(a={value:a}),n=function(t,r){e.similar(t,a)&&i.push(r)}),e.each(t(r)?this.parameterStore[r]:[this.parameterStore[r]],n)),i},removeParameters:function(e,r){if(void 0!==this.parameterStore[e]){if("number"==typeof r?r=[r]:Array.isArray(r)||(r=this.findParameters(e,r)),t(e)&&r.length!=this.parameterStore[e].length){r.sort(function(e,t){return e<t?-1:e>t?1:0});for(var a=r.length-1;a>=0;--a)this.parameterStore[e].splice(r[a],1)}else delete this.parameterStore[e];return r.length}return!1},getParameter:function(e,r){var a=t(e);return void 0===this.parameterStore[e]?a&&null==r?[]:{name:e}:null!=r&&a?this.parameterStore[e][r]:this.parameterStore[e]},getAllValues:function(e){var r=null;return void 0!==this.parameterStore[e]&&(r=t(e)?this.parameterStore[e].map(function(e){return e.value}):this.parameterStore[e].value),r},enumerateParameters:function(t,r){"boolean"!=typeof t&&(r=t,t=!0),e.each(this.parameterStore,function(a){t&&Array.isArray(a)?e.each(a,r):r(a)})},resetParameters:function(){this.parameterStore={}}},function(e,t){e.Compatibility=function(e){t.extend(!0,this,e),this.store.root=this},e.Compatibility.prototype={store:{addByValue:function(e,t,r){return this.root.addParameter(e,t,r)},removeByValue:function(e,t){return this.root.removeParameters(e,indices)},find:function(e,t){return this.root.findParameters(e,neddle)}}}}(Solr,asSys),Solr.stringifyDomain=function(t){var r=[];return e.each(t.domain,function(e,t){r.push(("type"!==t?t+"=":"")+e)}),r.length>0?"{!"+r.join(" ")+"}":""},Solr.QueryingURL=function(t){e.extend(!0,this,t)};var r=function(t){if(Array.isArray(t))return t.join(",");if("object"!=typeof t)return t.toString();var r=[];return e.each(t,function(e,t){r.push(t+":"+Solr.escapeValue(e))}),r.join(" ")};Solr.QueryingURL.prototype={__expects:["enumerateParameters"],prepareParameter:function(e){var t=Solr.stringifyDomain(e);return e.value||t?e.name+"="+encodeURIComponent(t+r(e.value||"")):null},prepareQuery:function(){var e=[],t=this;return this.enumerateParameters(function(r){var a=t.prepareParameter(r);null!=a&&e.push(a)}),{url:"?"+e.join("&")}},parseQuery:function(e){return e}};var a=function(e){return e.match(/^(json\.nl|json\.wrf|q|wt|start)/)},n=function(e){var t=e.match(/^json\.?(.*)/);return t&&t[1]};Solr.QueryingJson=function(t){this.useBody=!0,e.extend(!0,this,t)},Solr.QueryingJson.prototype={__expects:["enumerateParameters"],prepareQuery:function(){var t=[],r={params:{}},i=function(r){if(a(r.name))return void t.push(Solr.QueryingURL.prototype.prepareParameter(r));var n=null;return n="string"==typeof r.value?Solr.stringifyDomain(r)+r.value:void 0!==r.domain?e.extend({},r.value,{domain:r.domain}):r.value};return this.enumerateParameters(!1,function(t){var a=Array.isArray(t)?t.map(i):i(t),s=Array.isArray(t)?t[0].name:t.name,o=n(s);void 0!=a&&(null!==o?e.path(r,o,a):r.params[s]=a)}),r=JSON.stringify(r),this.useBody?{url:"?"+t.join("&"),data:r,contentType:"application/json",type:"POST",method:"POST"}:(t.push(encodeURIComponent(r)),{url:"?"+t.join("&")})},parseQuery:function(t){if(null!=t.responseHeader.params.json){var r=JSON.parse(t.responseHeader.params.json);e.extend(t.responseHeader.params,r,r.params),delete t.responseHeader.params.json}return t}},Solr.Persistency=function(t){e.extend(!0,this,t),this.storage={}},Solr.Persistency.prototype={__depends:[Solr.Configuring],persistentParams:[],addParameter:function(t,r,a){return e.pass(this,"addParameter",Solf.Configuring,t,r,a),t},removeParameters:function(t){e.pass(this,"removeParameters",Solf.Configuring,t)},onPrepare:function(e){}},Solr.Paging=function(t){e.extend(!0,this,t),this.manager=null,this.currentPage=this.totalPages=this.totalEntries=null},Solr.Paging.prototype={pageSize:20,multivalue:!1,exclusion:!1,domain:null,init:function(e){this.manager=e,this.manager.addParameter("rows",this.pageSize)},setPage:function(e){return null!=this.totalPages&&("next"===e||">"===e?e=this.currentPage+1:"prev"===e||"previous"===e||"<"===e?e=this.currentPage-1:"first"===e||"start"===e?e=1:"last"===e||"end"===e?e=this.totalPages:"number"!=typeof e&&(e=parseInt(e)),!(e>this.totalPages||e<1||e===this.currentPage)&&(this.currentPage=e,this.manager.addParameter("start",(e-1)*this.pageSize,this.domain)))},page:function(e){return void 0!==e&&this.setPage(e),this.currentPage},previousPage:function(){return this.currentPage>1?this.currentPage-1:null},nextPage:function(){return this.currentPage<this.totalPages?this.currentPage+1:null},afterRequest:function(){var e=parseInt(this.manager.response.responseHeader&&this.manager.response.responseHeader.params&&this.manager.response.responseHeader.params.start||this.manager.getParameter("start").value||0);this.pageSize=parseInt(this.manager.response.responseHeader&&this.manager.response.responseHeader.params&&this.manager.response.responseHeader.params.rows||this.manager.getParameter("rows").value||this.pageSize),this.totalEntries=parseInt(this.manager.response.response.numFound),this.currentPage=Math.floor(e/this.pageSize)+1,this.totalPages=Math.ceil(this.totalEntries/this.pageSize)},clickHandler:function(e){var t=this;return function(){return t.setPage(e)&&t.manager.doRequest(),!1}}},Solr.Requesting=function(e){this.manager=null,e&&(this.customResponse=e.customResponse,this.resetPage=!!e.resetPage)},Solr.Requesting.prototype={resetPage:!0,customResponse:null,init:function(t){e.pass(this,Solr.Requesting,"init",t),this.manager=t},doRequest:function(){this.resetPage&&this.manager.addParameter("start",0),this.manager.doRequest(self.customResponse)},clickHandler:function(e){var t=this;return function(r){return t.addValue(e)&&t.doRequest(),!1}},unclickHandler:function(e){var t=this;return function(r){return t.removeValue(e)&&t.doRequest(),!1}}},Solr.Delaying=function(e){this.delayTimer=null,this.delayed=e&&e.delayed||this.delayed},Solr.Delaying.prototype={delayed:!1,doRequest:function(){var t=this,r=function(){e.pass(this,Solr.Delaying,"doRequest"),t.delayTimer=null};return null==this.delayed||this.delayed<10?r():(null!=this.delayTimer&&clearTimeout(this.delayTimer),void(this.delayTimer=setTimeout(r,this.delayed)))}},Solr.Patterning=function(t){this.valuePattern=t&&t.valuePattern||this.valuePattern;var r=this.fqRegExp.toString().replace(/^\/\^?|\$?\/$/g,""),a="^"+e.escapeRegExp(this.valuePattern.replace(/\{\{!?-\}\}/g,"-?").replace("{{v}}","__v__")).replace("__v__",r).replace("--?","-?").replace("--","");this.fqRegExp=new RegExp(a)},Solr.Patterning.prototype={valuePattern:"{{-}}{{v}}",fqValue:function(t,r){return this.valuePattern.replace("{{-}}",r?"-":"").replace("{{!-}}",r?"":"-").replace("{{v}}",e.pass(this,Solr.Patterning,"fqValue",t,r)).replace("--","")}},Solr.Texting=function(e){this.manager=null,null!=e&&(this.domain=e.domain||this.domain,this.customResponse=e.customResponse)},Solr.Texting.prototype={domain:null,customResponse:null,init:function(t){e.pass(this,Solr.Texting,"init",t),this.manager=t},set:function(t){var r=this.manager.getParameter("q"),a=this.manager.addParameter("q",t,this.domain);return after=this.manager.getParameter("q"),a&&!e.equal(r,after)},clear:function(){return this.manager.removeParameters("q")},unclickHandler:function(){var e=this;return function(){return e.clear()&&e.doRequest(),!1}},clickHandler:function(e){var t=this;return function(){return t.set(e)&&t.doRequest(),!1}}};var i={prefix:null,sort:null,limit:null,offset:null,mincount:null,missing:null,method:null,"enum.cache.minDf":null},s=/^\s*\(\s*|\s*\)\s*$/g;Solr.facetValue=function(e){return Array.isArray(e)?1==e.length?Solr.escapeValue(e[0]):"("+e.map(function(e){return Solr.escapeValue(e)}).join(" ")+")":Solr.escapeValue(e)},Solr.parseFacet=function(e){for(var t=e.replace(s,"").replace(/\\"/g,"%0022").match(/"[^\s:\/"]+"|[^\s"]+/g),r=0,a=t.length;r<a;++r)t[r]=t[r].replace(/^"|"$/,"").replace("%0022",'"');return a>1?t:t[0]},Solr.Faceting=function(t){e.extend(!0,this,t),this.manager=null,this.multivalue||(this.aggregate=!1),this.fqRegExp=new RegExp("^-?"+this.field+":([^]+)")},Solr.Faceting.prototype={multivalue:!1,aggregate:!1,exclusion:!1,domain:null,useJson:!1,facet:{},init:function(t){e.pass(this,Solr.Faceting,"init",t),this.manager=t;var r=null;if(this.exclusion&&(this.domain=e.extend(this.domain,{tag:this.id+"_tag"}),r=this.id+"_tag"),this.useJson){var a={type:"terms",field:this.field,mincount:1,limit:-1};this.fqName="json.filter",null!=r&&(a.domain={excludeTags:r}),this.manager.addParameter("json.facet."+this.id,e.extend(a,this.facet))}else{var n=this,s=e.extend({},i),o={key:this.id};null!=r&&(o.ex=r),this.fqName="fq",this.manager.addParameter("facet",!0),void 0!==this.facet.date?(this.manager.addParameter("facet.date",this.field,o),e.extend(s,{"date.start":null,"date.end":null,"date.gap":null,"date.hardend":null,"date.other":null,"date.include":null})):void 0!==this.facet.range?(this.manager.addParameter("facet.range",this.field,o),e.extend(s,{"range.start":null,"range.end":null,"range.gap":null,"range.hardend":null,"range.other":null,"range.include":null})):(this.facet.field=!0,this.manager.addParameter("facet.field",this.field,o)),s=e.common(this.facet,s),e.each(s,function(e,t){n.manager.addParameter("f."+n.field+".facet."+t,e)})}},addValue:function(e,t){this.multivalue||this.clearValues();var r;if(!this.aggregate||!(r=this.manager.findParameters(this.fqName,this.fqRegExp)).length)return this.manager.addParameter(this.fqName,this.fqValue(e,t),this.domain);var a=this.manager.getParameter(this.fqName,r[0]),n=this.fqParse(a.value),i=!1;Array.isArray(e)||(e=[e]);for(var s,o=0,u=e.length;o<u;++o)s=e[o],n!=s&&(Array.isArray(n)&&n.indexOf(s)>=0||("string"==typeof n&&(n=[n]),n.push(s),i=!0));return!!i&&(a.value=this.fqValue(n,t),!0)},removeValue:function(e){if(this.multivalue){var t=this,r=!1;return this.manager.removeParameters(this.fqName,function(a){var n,i;return!!a.value.match(t.fqRegExp)&&(t.aggregate?(n=t.fqParse(a.value),Array.isArray(e)||(e=[e]),Array.isArray(n)?(n=n.filter(function(t){return e.indexOf(t)==-1||(r=!0,!1)}),!n.length||(1==n.length&&(n=n[0]),a.value=t.fqValue(n),!1)):(r=r||(i=e.indexOf(n)>=0),i)):(r=r||(i=a.value.indexOf(Solr.facetValue(e))>=0),i))}),r}return this.clearValues()},hasValue:function(e){for(var t,r=this.manager.findParameters(this.fqName,this.fqRegExp),e=Solr.escapeValue(e),a=0,n=r.length;a<n;++a)if(t=this.manager.getParameter(this.fqName,r[a]),t.value.replace(this.fqRegExp,"").indexOf(e)>-1)return!0;return!1},clearValues:function(){return this.manager.removeParameters(this.fqName,this.fqRegExp)},getFacetCounts:function(e){var t;if(null==e&&(e=this.manager.response.facet_counts),this.useJson===!0)return e.count>0?e[this.id].buckets:[];if(void 0!==this.facet.field?t="facet_fields":void 0!==this.facet.date?t="facet_dates":void 0!==this.facet.range&&(t="facet_ranges"),void 0!==t)switch(this.manager.getParameter("json.nl").value){case"map":return this.getFacetCountsMap(e,t);case"arrarr":return this.getFacetCountsArrarr(e);default:return this.getFacetCountsFlat(e)}throw'Cannot get facet counts unless one of the following properties is set to "true" on widget "'+this.id+'": "facet.field", "facet.date", or "facet.range".'},getFacetCountsMap:function(e,t){var r=[];for(var a in e[t][this.id])r.push({val:a,count:parseInt(e[t][this.id][a])});return r},getFacetCountsArrarr:function(e,t){for(var r=[],a=0,n=e[t][this.id].length;a<n;a++)r.push({val:e[t][this.id][a][0],count:parseInt(e[t][this.id][a][1])});return r},getFacetCountsFlat:function(e,t){for(var r=[],a=0,n=e[t][this.id].length;a<n;a+=2)r.push({val:e[t][this.id][a],count:parseInt(e[t][this.id][a+1])});return r},fqValue:function(e,t){return(t?"-":"")+this.field+":"+Solr.facetValue(e)},fqParse:function(e){var t=e.match(this.fqRegExp);return null!=t?Solr.parseFacet(t[1]):null}},Solr.rangeValue=function(e){return Array.isArray(e)?"["+Solr.escapeValue(e[0]||"*")+" TO "+Solr.escapeValue(e[1]||"*")+"]":Solr.escapeValue(e)},Solr.parseRange=function(e){var t=e.match(/(-?)([^\s:]+):\s*\[\s*([^\s]+)\s+TO\s+([^\s]+)\s*\]/);return t?{field:t[2],exclude:!!t[1],value:[t[3],t[4]]}:null},Solr.Ranging=function(t){e.extend(!0,this,t),this.manager=null,this.fqRegExp=new RegExp("^-?"+this.field+":\\s*\\[\\s*[^\\s]+\\s+TO\\s+[^\\s]+\\s*\\]")},Solr.Ranging.prototype={multirange:!1,exclusion:!1,domain:null,useJson:!1,init:function(t){e.pass(this,Solr.Ranging,"init",t),this.manager=t,this.exclusion&&(this.domain=e.extend(this.domain,{tag:this.id+"_tag"})),this.fqName=this.useJson?"json.filter":"fq"},addValue:function(e,t){return this.clearValues(),this.manager.addParameter(this.fqName,this.fqValue(e,t),this.domain)},removeValue:function(e){return this.clearValues()},hasValue:function(e){return null!=this.manager.findParameters(this.fqName,this.fqRegExp)},clearValues:function(){return this.manager.removeParameters(this.fqName,this.fqRegExp)},fqValue:function(e,t){return(t?"-":"")+this.field+":"+Solr.rangeValue(e)}},"object"==typeof module&&module&&"object"==typeof module.exports?module.exports=Solr:(this.Solr=Solr,"function"==typeof define&&define.amd&&define(Solr))}(asSys);
